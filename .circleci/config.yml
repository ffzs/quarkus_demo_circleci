version: 2
jobs:
  build:

    working_directory: ~/quarkus_demo_circleci

    docker:
      - image: circleci/openjdk:11-jdk-stretch
        environment:
          POSTGRE_HOST: localhost
      - image: quay.io/quarkus/ubi-quarkus-native-image:20.2.0-java11
      - image: circleci/postgres:10.5
        auth:
          username: ffzs
          password: $DOCKERHUB_PASSWORD
        environment:
          POSTGRES_USER: ffzs
          POSTGRES_PASSWORD: 123zxc
          POSTGRES_DB: mydb

    steps:
      - checkout
      - restore_cache:
          key: circleci-demo-java-spring-{{ checksum "pom.xml" }}
      - setup_remote_docker:
          docker_layer_caching: true
      - run: chmod +x mvnw
      - run: ./mvnw package -Pnative -Dquarkus.native.container-build=true

      - store_artifacts:
          path: target/quarkus_demo-1.0.0-SNAPSHOT-runner

